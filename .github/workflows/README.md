# ğŸš€ GitHub Actions å·¥ä½œæµä½¿ç”¨æŒ‡å—

æœ¬é¡¹ç›®æä¾›å¤šä¸ªå·¥ä½œæµæ¥æ”¯æŒä¸åŒçš„æ„å»ºå’Œå‘å¸ƒéœ€æ±‚ï¼Œç¡®ä¿åœ¨æ²¡æœ‰æœ¬åœ°æ„å»ºç¯å¢ƒçš„æƒ…å†µä¸‹ä¹Ÿèƒ½ç¨³å®šå‘å¸ƒ APKã€‚

## ğŸ“‹ å·¥ä½œæµæ¦‚è§ˆ

| å·¥ä½œæµ | ä¸»è¦ç”¨é€” | è§¦å‘æ–¹å¼ | é€‚ç”¨åœºæ™¯ |
|--------|----------|----------|----------|
| `test-build.yml` | æµ‹è¯•æ„å»ºéªŒè¯ | æ‰‹åŠ¨/PR/æ¨é€ | å¼€å‘æµ‹è¯•ã€CIéªŒè¯ |
| `upload.yml` | æ­£å¼/é¢„å‘å¸ƒæ„å»º | Releaseåˆ›å»º/æ‰‹åŠ¨ | å‘å¸ƒæ„å»ºã€é¢„å‘å¸ƒæµ‹è¯• |
| `release.yml` | ç‰ˆæœ¬å‘å¸ƒç®¡ç† | æ‰‹åŠ¨ | åˆ›å»ºæ­£å¼ç‰ˆæœ¬å· |

## ğŸ”’ å®‰å…¨æ—¥å¿—æ”¶é›†ç³»ç»Ÿ

### ğŸ›¡ï¸ æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
æ‰€æœ‰å·¥ä½œæµéƒ½é›†æˆäº†å®Œæ•´çš„æ—¥å¿—æ”¶é›†ç³»ç»Ÿï¼Œå…·æœ‰ä»¥ä¸‹å®‰å…¨ç‰¹æ€§ï¼š

#### **è‡ªåŠ¨è¿‡æ»¤çš„æ•æ„Ÿä¿¡æ¯**ï¼š
- âœ… **GitHub Tokens**: `ghp_*`, `gho_*`, `ghu_*`, `ghs_*`, `ghr_*`
- âœ… **ç­¾åå¯†é’¥**: JKS keystore æ•°æ®ã€å¯†ç ã€keyAlias
- âœ… **ç¯å¢ƒå˜é‡**: `CACHIX_TOKEN`, `WORKFLOW_TOKEN`, å…¶ä»– secrets
- âœ… **é‚®ç®±åœ°å€**: éƒ¨åˆ†æ©ç å¤„ç† `***@***.***`
- âœ… **é€šç”¨å¯†é’¥**: 8ä½ä»¥ä¸Šçš„ secret æ¨¡å¼

#### **æ—¥å¿—æ”¶é›†æœºåˆ¶**ï¼š
- ğŸ“ **å®Œæ•´è®°å½•**: æ¯ä¸ªå‘½ä»¤çš„å®Œæ•´è¾“å‡ºå’Œé”™è¯¯ä¿¡æ¯
- ğŸ”„ **è‡ªåŠ¨è¿‡æ»¤**: å®æ—¶è¿‡æ»¤æ•æ„Ÿæ•°æ®ï¼Œç¡®ä¿æ—¥å¿—å®‰å…¨
- ğŸ“¦ **Artifact ä¿å­˜**: æ‰€æœ‰æ—¥å¿—ä½œä¸º artifacts ä¿å­˜30å¤©
- ğŸ¯ **å¤±è´¥ä¿ç•™**: å³ä½¿æ„å»ºå¤±è´¥ï¼Œæ—¥å¿—ä¹Ÿä¼šå®Œæ•´ä¿å­˜

#### **æ—¥å¿—æ–‡ä»¶ç»“æ„**ï¼š
```
build-logs-20231215_1020.tar.gz
â”œâ”€â”€ system-info-20231215_1020.txt     # ç³»ç»Ÿç¯å¢ƒä¿¡æ¯
â”œâ”€â”€ build-copy-20231215_1020-filtered.log  # åŸºç¡€ç‰ˆæ„å»ºæ—¥å¿—
â”œâ”€â”€ build-copy-extra-20231215_1020-filtered.log  # å®Œæ•´ç‰ˆæ„å»ºæ—¥å¿—
â”œâ”€â”€ sign-apks-20231215_1020-filtered.log  # APKç­¾åæ—¥å¿—
â”œâ”€â”€ upload-copy-20231215_1020-filtered.log  # ä¸Šä¼ æ—¥å¿—
â””â”€â”€ build-summary-20231215_1020.txt   # æ„å»ºæ‘˜è¦
```

## ğŸ§ª æµ‹è¯•æ„å»º (`test-build.yml`)

### è§¦å‘æ–¹å¼

#### 1. æ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èç”¨äºæµ‹è¯•ï¼‰
```bash
# åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘
# è¾“å…¥å‚æ•°ï¼š
# - build_type: test/preview/rc
# - version_suffix: beta1/rc2 (å¯é€‰)
# - upload_artifacts: true/false
```

#### 2. è‡ªåŠ¨è§¦å‘
- **Pull Request**: å½“ PR æ¶‰åŠæ„å»ºç›¸å…³æ–‡ä»¶æ—¶è‡ªåŠ¨è§¦å‘
- **åˆ†æ”¯æ¨é€**: æ¨é€åˆ° `android-fixes` æˆ– `develop` åˆ†æ”¯æ—¶è§¦å‘

### ç‰ˆæœ¬å·è§„åˆ™
- **PR æ„å»º**: `test-pr123` (ç‰ˆæœ¬ç : 900123)
- **åˆ†æ”¯æ„å»º**: `test-fixes-1a2b3c4` (ç‰ˆæœ¬ç : 8002b3c4)  
- **æ‰‹åŠ¨æ„å»º**: `test-202312151030-beta1` (ç‰ˆæœ¬ç : 71030)

### äº§ç‰©
- âœ… ç­¾ååçš„ APK æ–‡ä»¶
- âœ… åŸºæœ¬éªŒè¯ï¼ˆæ–‡ä»¶å¤§å°ã€æ ¼å¼æ£€æŸ¥ï¼‰
- âœ… 30å¤©ä¿å­˜æœŸçš„ Artifacts
- âœ… **å®Œæ•´çš„è¿‡æ»¤æ—¥å¿—**ï¼ˆåŒ…å«æ‰€æœ‰æ„å»ºç»†èŠ‚ï¼‰
- âœ… ç³»ç»Ÿç¯å¢ƒä¿¡æ¯è®°å½•

## ğŸ“¦ å‘å¸ƒæ„å»º (`upload.yml`)

### è§¦å‘æ–¹å¼

#### 1. è‡ªåŠ¨è§¦å‘ï¼ˆæ­£å¼å‘å¸ƒï¼‰
```bash
# å½“ release.yml åˆ›å»ºæ–° Release æ—¶è‡ªåŠ¨è§¦å‘
# æ„å»ºå¯¹åº”ç‰ˆæœ¬çš„æ­£å¼ APK
```

#### 2. æ‰‹åŠ¨è§¦å‘ï¼ˆçµæ´»æ§åˆ¶ï¼‰
```bash
# åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘
# è¾“å…¥å‚æ•°ï¼š
# - target_release: v0.0.13 (ç•™ç©ºä½¿ç”¨æœ€æ–°)
# - build_purpose: release/prerelease/test
```

### æ„å»ºç±»å‹

#### ğŸ¯ Release (æ­£å¼å‘å¸ƒ)
- **ç‰ˆæœ¬ç **: æ­£å¸¸ç‰ˆæœ¬å·ï¼ˆå¦‚ 00013ï¼‰
- **æ–‡ä»¶å**: `koishi-android-v0.0.13.apk`
- **ä¸Šä¼ **: åˆ° GitHub Release é¡µé¢
- **ç”¨é€”**: æ­£å¼å‘å¸ƒç»™ç”¨æˆ·
- **æ—¥å¿—**: åŒ…å«å®Œæ•´æ„å»ºå’Œä¸Šä¼ è¿‡ç¨‹

#### ğŸš€ Prerelease (é¢„å‘å¸ƒ)
- **ç‰ˆæœ¬ç **: 9å‰ç¼€ï¼ˆå¦‚ 900013ï¼‰
- **æ–‡ä»¶å**: `koishi-android-v0.0.13-pre.apk`
- **ä¸Šä¼ **: åˆ° GitHub Release é¡µé¢ï¼ˆæ ‡è®°ä¸ºé¢„å‘å¸ƒï¼‰
- **ç”¨é€”**: å…¬å¼€æµ‹è¯•ã€RCç‰ˆæœ¬
- **æ—¥å¿—**: å®Œæ•´çš„é¢„å‘å¸ƒæ„å»ºæ—¥å¿—

#### ğŸ§ª Test (æµ‹è¯•)
- **ç‰ˆæœ¬ç **: 8å‰ç¼€ï¼ˆå¦‚ 800013ï¼‰
- **æ–‡ä»¶å**: ä½œä¸º Artifact ä¿å­˜
- **ä¸Šä¼ **: GitHub Actions Artifactsï¼ˆ7å¤©ï¼‰
- **ç”¨é€”**: å†…éƒ¨æµ‹è¯•ã€éªŒè¯æ„å»º
- **æ—¥å¿—**: è¯¦ç»†çš„æµ‹è¯•æ„å»ºæ—¥å¿—

## ğŸ·ï¸ ç‰ˆæœ¬ç®¡ç† (`release.yml`)

### è§¦å‘æ–¹å¼
- **ä»…æ‰‹åŠ¨è§¦å‘**: ç¡®ä¿ç‰ˆæœ¬å·å—æ§

### åŠŸèƒ½
- âœ… è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·ï¼ˆv0.0.12 â†’ v0.0.13ï¼‰
- âœ… è¯­ä¹‰åŒ–ç‰ˆæœ¬éªŒè¯
- âœ… é‡å¤æ ‡ç­¾æ£€æŸ¥
- âœ… è‡ªåŠ¨ç”Ÿæˆ Release Notes
- âœ… **å®Œæ•´çš„ç‰ˆæœ¬åˆ›å»ºæ—¥å¿—**
- âœ… å¹¶å‘æ§åˆ¶é˜²æ­¢é‡å¤åˆ›å»º

## ğŸ”„ æ¨èå·¥ä½œæµç¨‹

### ğŸ§ª å¼€å‘æµ‹è¯•é˜¶æ®µ
```mermaid
graph TD
    A[ä»£ç ä¿®æ”¹] --> B[æ¨é€åˆ° android-fixes]
    B --> C[è‡ªåŠ¨è§¦å‘ test-build.yml]
    C --> D[ä¸‹è½½ Artifacts å’Œæ—¥å¿—]
    D --> E[éªŒè¯åŠŸèƒ½æ­£å¸¸]
    E --> F[åˆ›å»º PR]
    F --> G[PR è‡ªåŠ¨è§¦å‘ test-build.yml]
    G --> H[å†æ¬¡éªŒè¯]
    H --> I{æµ‹è¯•é€šè¿‡?}
    I -->|æ˜¯| J[åˆå¹¶ä»£ç ]
    I -->|å¦| K[æŸ¥çœ‹æ—¥å¿—ä¿®å¤é—®é¢˜]
```

### ğŸš€ å‘å¸ƒå‡†å¤‡é˜¶æ®µ
```mermaid
graph TD
    A[ä»£ç åˆå¹¶åˆ°ä¸»åˆ†æ”¯] --> B[æ‰‹åŠ¨è§¦å‘ test-build.yml]
    B --> C[é€‰æ‹© build_type=preview]
    C --> D[ä¸‹è½½æµ‹è¯•ç‰ˆå’Œæ—¥å¿—]
    D --> E[éªŒè¯æ— é—®é¢˜]
    E --> F[æ‰‹åŠ¨è§¦å‘ release.yml]
    F --> G[åˆ›å»ºæ­£å¼ Release]
    G --> H[è‡ªåŠ¨è§¦å‘ upload.yml]
    H --> I[ä¸‹è½½å‘å¸ƒæ—¥å¿—]
    I --> J[æ­£å¼å‘å¸ƒ]
```

### ğŸ”„ ç´§æ€¥ä¿®å¤æµç¨‹
```mermaid
graph TD
    A[å‘ç°ç´§æ€¥é—®é¢˜] --> B[ä¿®å¤ä»£ç ]
    B --> C[æ‰‹åŠ¨è§¦å‘ upload.yml]
    C --> D[é€‰æ‹© build_purpose=prerelease]
    D --> E[ä¸‹è½½ä¿®å¤ç‰ˆå’Œæ—¥å¿—]
    E --> F[éªŒè¯ä¿®å¤]
    F --> G[æ‰‹åŠ¨è§¦å‘ release.yml]
    G --> H[æ­£å¼å‘å¸ƒ]
```

## ğŸ“Š æ—¥å¿—åˆ†æå’Œè°ƒè¯•

### ğŸ” æŸ¥çœ‹æ—¥å¿—
1. **è¿›å…¥ Actions é¡µé¢**: GitHub â†’ Actions
2. **é€‰æ‹©å·¥ä½œæµè¿è¡Œ**: ç‚¹å‡»å¯¹åº”çš„å·¥ä½œæµ
3. **ä¸‹è½½æ—¥å¿— Artifact**: åœ¨ Artifacts éƒ¨åˆ†ä¸‹è½½ `*-logs-*.tar.gz`
4. **è§£å‹æŸ¥çœ‹**: åŒ…å«æ‰€æœ‰è¿‡æ»¤åçš„æ—¥å¿—æ–‡ä»¶

### ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

#### **æ„å»ºå¤±è´¥**
```bash
# æŸ¥çœ‹æ„å»ºæ—¥å¿—
cat build-*-filtered.log | grep -i error

# æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯
cat system-info-*.txt

# æŸ¥çœ‹æ„å»ºæ‘˜è¦
cat build-summary-*.txt
```

#### **ç­¾åé—®é¢˜**
```bash
# æŸ¥çœ‹ç­¾åæ—¥å¿—
cat sign-*-filtered.log | grep -i sign

# æ£€æŸ¥å¯†é’¥é…ç½®ï¼ˆå·²è¿‡æ»¤ï¼‰
grep "signingKey\|keyStorePassword\|keyPassword" sign-*-filtered.log
```

#### **ä¸Šä¼ å¤±è´¥**
```bash
# æŸ¥çœ‹ä¸Šä¼ æ—¥å¿—
cat upload-*-filtered.log | grep -i "upload\|error"

# æ£€æŸ¥ç½‘ç»œè¿æ¥
curl -I https://api.github.com
```

### ğŸ“ˆ æ€§èƒ½åˆ†æ
```bash
# æŸ¥çœ‹æ„å»ºæ—¶é—´
grep "real\|user\|sys" build-*-filtered.log

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
grep -i "memory\|ram" system-info-*.txt

# æŸ¥çœ‹ç£ç›˜ç©ºé—´
grep -i "disk\|space" system-info-*.txt
```

## ğŸ›ï¸ å‚æ•°è¯´æ˜

### test-build.yml è¾“å…¥å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `build_type` | é€‰æ‹© | test | test/preview/rc |
| `version_suffix` | æ–‡æœ¬ | '' | beta1/rc2ç­‰åç¼€ |
| `upload_artifacts` | å¸ƒå°” | true | æ˜¯å¦ä¸Šä¼ Artifacts |

### upload.yml è¾“å…¥å‚æ•°
| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `target_release` | æ–‡æœ¬ | '' | ç›®æ ‡ç‰ˆæœ¬å· |
| `build_purpose` | é€‰æ‹© | release | release/prerelease/test |

## ğŸ“± ç‰ˆæœ¬å·ç®¡ç†

### ç‰ˆæœ¬ç åˆ†é…è§„åˆ™
| èŒƒå›´ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| 00001-09999 | æ­£å¼å‘å¸ƒ | 00013 (v0.0.13) |
| 10000-19999 | ä¿ç•™ | - |
| 70000-79999 | æ‰‹åŠ¨æµ‹è¯• | 71030 |
| 80000-89999 | åˆ†æ”¯æ„å»º | 8002b3c4 |
| 90000-99999 | PRæ„å»º | 900123 |

### æ–‡ä»¶å‘½åè§„åˆ™
```
æ­£å¼ç‰ˆ: koishi-android-v0.0.13.apk
é¢„å‘å¸ƒ: koishi-android-v0.0.13-pre.apk
æµ‹è¯•ç‰ˆ: test-pr123.apk (Artifacts)
æ—¥å¿—: build-logs-20231215_1020.tar.gz
```

## ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ

### ğŸ”’ æ—¥å¿—å®‰å…¨
- âœ… **è‡ªåŠ¨è¿‡æ»¤**: æ‰€æœ‰æ•æ„Ÿä¿¡æ¯åœ¨ä¿å­˜å‰è¢«è¿‡æ»¤
- âœ… **æ¨¡å¼åŒ¹é…**: ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¯†åˆ«æ•æ„Ÿæ•°æ®
- âœ… **æ›¿æ¢ç­–ç•¥**: æ•æ„Ÿæ•°æ®æ›¿æ¢ä¸º `***` æˆ–æ©ç å½¢å¼
- âœ… **å¤šé‡éªŒè¯**: å¤šå±‚è¿‡æ»¤ç¡®ä¿æ— é—æ¼

### ğŸš« ç¦æ­¢æ“ä½œ
- âŒ ä¸è¦åœ¨æ—¥å¿—ä¸­æ‰“å°ä»»ä½• secrets
- âŒ ä¸è¦ç¦ç”¨æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
- âŒ ä¸è¦å°†æœªè¿‡æ»¤çš„æ—¥å¿—ä¸Šä¼ åˆ°å…¬å¼€ä½ç½®
- âŒ ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯

### âœ… æ¨èåšæ³•
- âœ… å®šæœŸæ£€æŸ¥è¿‡æ»¤è§„åˆ™çš„æœ‰æ•ˆæ€§
- âœ… ä½¿ç”¨ GitHub Secrets ç®¡ç†æ•æ„Ÿä¿¡æ¯
- âœ… å®šæœŸè½®æ¢å¯†é’¥å’Œä»¤ç‰Œ
- âœ… ç›‘æ§æ—¥å¿—è®¿é—®è®°å½•

## ğŸ“ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **æ„å»ºå¤±è´¥**: æ£€æŸ¥ `test-build.yml` å…ˆéªŒè¯
2. **ç‰ˆæœ¬å†²çª**: `release.yml` ä¼šè‡ªåŠ¨æ£€æŸ¥
3. **ä¸Šä¼ å¤±è´¥**: ç¡®è®¤ Release å·²åˆ›å»º
4. **æƒé™é—®é¢˜**: æ£€æŸ¥ Secrets é…ç½®
5. **æ—¥å¿—ç¼ºå¤±**: ç¡®è®¤ `if: always()` æ¡ä»¶è®¾ç½®

### è°ƒè¯•æŠ€å·§
- æŸ¥çœ‹ Actions æ—¥å¿—çš„è¯¦ç»†è¾“å‡º
- ä½¿ç”¨ `test-build.yml` éªŒè¯ä»£ç 
- æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦ç¬¦åˆè§„èŒƒ
- ç¡®è®¤æ‰€æœ‰å¿…è¦çš„ Secrets å·²é…ç½®
- **ä¸‹è½½å®Œæ•´çš„è¿‡æ»¤æ—¥å¿—è¿›è¡Œæ·±åº¦åˆ†æ**

### ğŸ”§ æ—¥å¿—è„šæœ¬ä½¿ç”¨
```bash
# æ‰‹åŠ¨ä½¿ç”¨æ—¥å¿—æ”¶é›†å™¨
./.github/scripts/log-collector.sh help

# æ”¶é›†ç³»ç»Ÿä¿¡æ¯
./.github/scripts/log-collector.sh collect-system

# æ‰§è¡Œå‘½ä»¤å¹¶è®°å½•æ—¥å¿—
./.github/scripts/log-collector.sh execute "test-command" "echo 'test'"

# è¿‡æ»¤æ•æ„Ÿæ•°æ®
./.github/scripts/log-collector.sh filter input.log output.log
```

---

ğŸ’¡ **æç¤º**: 
- æ‰€æœ‰æ„å»ºæ—¥å¿—éƒ½ä¼šè‡ªåŠ¨ä¿å­˜ï¼Œå³ä½¿æ„å»ºå¤±è´¥ä¹Ÿä¸ä¼šä¸¢å¤±
- æ•æ„Ÿä¿¡æ¯å·²è¢«è‡ªåŠ¨è¿‡æ»¤ï¼Œå¯ä»¥å®‰å…¨åˆ†äº«æ—¥å¿—è¿›è¡Œè°ƒè¯•
- å»ºè®®åœ¨æ­£å¼å‘å¸ƒå‰å§‹ç»ˆä½¿ç”¨ `test-build.yml` è¿›è¡ŒéªŒè¯ï¼