permissions:
  contents: write
  releases: write

on:
  release:
    types:
      - created
  workflow_dispatch:
    inputs:
      target_release:
        description: 'Target release tag (leave empty for latest)'
        required: false
        default: ''
        type: string
      build_purpose:
        description: 'Build purpose'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - prerelease
          - test

jobs:
  upload:
    strategy:
      matrix:
        build:
          - name: koishi-android
            copy: copy
          - name: koishi-android-with-chromium
            copy: copy-extra
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up variables
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # Release created event - use event payload
            TAG="${{ github.event.release.tag_name }}"
            UPLOAD_URL="${{ github.event.release.upload_url }}"
            IS_PRERELEASE="${{ github.event.release.prerelease }}"
            echo "Triggered by release creation: $TAG"
          else
            # Manual trigger - determine target
            INPUT_TAG="${{ github.inputs.target_release }}"
            BUILD_PURPOSE="${{ github.inputs.build_purpose }}"
            
            if [[ -n "$INPUT_TAG" ]]; then
              TAG="$INPUT_TAG"
            else
              # Get latest release
              LATEST_RELEASE=$(curl \
                -sS \
                -H 'Accept: application/vnd.github.v3+json' \
                -H 'Authorization: token ${{ github.token }}' \
                https://api.github.com/repos/${{ github.repository }}/releases/latest)
              TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
            fi
            
            # For manual triggers, we need to construct upload_url
            UPLOAD_URL="https://uploads.github.com/repos/${{ github.repository }}/releases"
            
            # Set prerelease flag based on input
            if [[ "$BUILD_PURPOSE" == "prerelease" ]]; then
              IS_PRERELEASE=true
            elif [[ "$BUILD_PURPOSE" == "test" ]]; then
              IS_PRERELEASE=true
            else
              IS_PRERELEASE=false
            fi
            
            echo "Manual trigger - target: $TAG, purpose: $BUILD_PURPOSE"
          fi
          
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "UPLOAD_URL=$UPLOAD_URL" >> $GITHUB_OUTPUT
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_OUTPUT

      - name: Validate release exists
        if: github.event_name == 'workflow_dispatch'
        run: |
          TAG="${{ steps.vars.outputs.TAG }}"
          
          # Check if release exists
          RELEASE_INFO=$(curl \
            -sS \
            -H 'Accept: application/vnd.github.v3+json' \
            -H 'Authorization: token ${{ github.token }}' \
            https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG)
          
          if [[ $(echo "$RELEASE_INFO" | jq -r '.message') == "Not Found" ]]; then
            echo "âŒ Release $TAG not found. Please create the release first."
            exit 1
          fi
          
          UPLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.upload_url' | cut -d'{' -f1)
          echo "UPLOAD_URL=$UPLOAD_URL" >> $GITHUB_OUTPUT
          echo "âœ… Found release: $TAG"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install nix
        uses: cachix/install-nix-action@v20

      - name: setup cachix
        uses: cachix/cachix-action@v12
        with:
          name: koishi
          authToken: ${{ secrets.CACHIX_TOKEN }}

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: gradle

      - name: Build
        run: |
          TAG="${{ steps.vars.outputs.TAG }}"
          BUILD_PURPOSE="${{ github.inputs.build_purpose || 'release' }}"
          
          # Adjust version code for different build types
          BASE_VERSION_CODE=$(echo "${TAG:1}" | sed 's/\.//g')
          
          case "$BUILD_PURPOSE" in
            "prerelease")
              VERSION_CODE="9${BASE_VERSION_CODE}"  # 9xxx for prerelease
              ;;
            "test")
              VERSION_CODE="8${BASE_VERSION_CODE}"  # 8xxx for test
              ;;
            *)
              VERSION_CODE="${BASE_VERSION_CODE}"   # Normal for release
              ;;
          esac
          
          export VERSION_CODE="$VERSION_CODE"
          export VERSION_NAME="$TAG"
          export COPY="${{ matrix.build.copy }}"
          
          echo "Building ${{ matrix.build.name }} with VERSION_CODE=$VERSION_CODE"
          ./build.sh

      - uses: ilharp/sign-android-release@v1
        name: Sign app APK
        id: sign_app
        with:
          keyAlias: koishi-android
          signingKey: ${{ secrets.JKS }}
          keyStorePassword: ${{ secrets.JKS_PASSWORD }}
          keyPassword: ${{ secrets.JKS_PASSWORD }}

      - name: Upload to Release
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.inputs.build_purpose != 'test')
        run: |
          # Prepare filename with build purpose suffix
          BUILD_PURPOSE="${{ github.inputs.build_purpose || 'release' }}"
          TAG="${{ steps.vars.outputs.TAG }}"
          FILENAME="${{ matrix.build.name }}-${TAG}"
          
          # Add suffix for non-release builds
          if [[ "$BUILD_PURPOSE" == "prerelease" ]]; then
            FILENAME="${FILENAME}-pre"
          elif [[ "$BUILD_PURPOSE" == "test" ]]; then
            FILENAME="${FILENAME}-test"
          fi
          
          FILENAME="${FILENAME}.apk"
          ENCODED_NAME=$(printf "%s" "$FILENAME" | jq -sRr @uri)
          
          echo "Uploading: $FILENAME"
          
          UPLOAD_RESPONSE=$(curl -s \
            -X POST \
            -H 'Accept: application/vnd.github.v3+json' \
            -H 'Content-Type: application/octet-stream' \
            -H 'Authorization: token ${{ github.token }}' \
            --data-binary @${{steps.sign_app.outputs.signedFile}} \
            "${{ steps.vars.outputs.UPLOAD_URL }}?name=${ENCODED_NAME}")
          
          # Check upload result
          BROWSER_URL=$(echo "$UPLOAD_RESPONSE" | jq -r '.browser_download_url')
          if [[ "$BROWSER_URL" == "" ]] || [[ -z "$BROWSER_URL" ]]; then
            echo "âŒ Upload failed"
            echo "Response: $UPLOAD_RESPONSE"
            exit 1
          fi
          
          echo "âœ… Uploaded successfully: $BROWSER_URL"
          echo "browser_url=$BROWSER_URL" >> $GITHUB_OUTPUT

      - name: Upload as Artifact (for test builds)
        if: github.event_name == 'workflow_dispatch' && github.inputs.build_purpose == 'test'
        uses: actions/upload-artifact@v4
        with:
          name: test-${{ matrix.build.name }}-${{ steps.vars.outputs.TAG }}
          path: ${{steps.sign_app.outputs.signedFile}}
          retention-days: 7

      - name: Build Summary
        run: |
          echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Variant:** ${{ matrix.build.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.vars.outputs.TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "**Purpose:** ${{ github.inputs.build_purpose || 'release' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ github.event_name }}" == "release" ]] || [[ "${{ github.inputs.build_purpose }}" != "test" ]]; then
            echo "### âœ… Uploaded to Release" >> $GITHUB_STEP_SUMMARY
            echo "APK has been uploaded to the GitHub Release page." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“¦ Available as Artifact" >> $GITHUB_STEP_SUMMARY
            echo "APK is available for download from the Actions artifacts." >> $GITHUB_STEP_SUMMARY
          fi