# ============================================
# Koishi Android å‘å¸ƒä¸Šä¼ å·¥ä½œæµ
# 
# åŠŸèƒ½è¯´æ˜Žï¼š
# - å°†æž„å»ºå¥½çš„APKä¸Šä¼ åˆ°GitHub Release
# - æ”¯æŒå¤šç§æž„å»ºç›®çš„ï¼šreleaseã€prereleaseã€test
# - è‡ªåŠ¨å¤„ç†ç‰ˆæœ¬ä»£ç é€‚é…ä¸åŒæž„å»ºç±»åž‹
# - æ”¯æŒæ‰‹åŠ¨è§¦å‘å’Œreleaseäº‹ä»¶è§¦å‘
# - æ‰§è¡ŒçŸ©é˜µæž„å»ºï¼šåŸºç¡€ç‰ˆå’ŒåŒ…å«Chromiumçš„å®Œæ•´ç‰ˆ
#
# è§¦å‘æ¡ä»¶ï¼š
# - releaseäº‹ä»¶ï¼šå½“åˆ›å»ºæ–°çš„releaseæ—¶è‡ªåŠ¨è§¦å‘
# - æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰ï¼šæ”¯æŒè‡ªå®šä¹‰ç›®æ ‡releaseå’Œæž„å»ºç›®çš„
#
# ä½œè€…ï¼šKoishi Androidå¼€å‘å›¢é˜Ÿ
# æ›´æ–°æ—¥æœŸï¼š2024-12-16
# ============================================

# å·¥ä½œæµæƒé™é…ç½®
permissions:
  contents: write       # å…è®¸å†™å…¥ä»“åº“å†…å®¹ï¼ˆç”¨äºŽåˆ›å»ºreleasesï¼‰
  releases: write       # å…è®¸å†™å…¥releases

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # Releaseäº‹ä»¶è§¦å‘ - å½“åˆ›å»ºæ–°releaseæ—¶
  release:
    types:
      - created  # ä»…åœ¨releaseåˆ›å»ºæ—¶è§¦å‘
  
  # æ‰‹åŠ¨è§¦å‘ - æ”¯æŒè‡ªå®šä¹‰å‚æ•°
  workflow_dispatch:
    inputs:
      # ç›®æ ‡releaseæ ‡ç­¾
      target_release:
        description: 'ç›®æ ‡releaseæ ‡ç­¾ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨æœ€æ–°ï¼‰'
        required: false
        default: ''
        type: string
      # æž„å»ºç›®çš„
      build_purpose:
        description: 'æž„å»ºç›®çš„'
        required: true
        default: 'release'
        type: choice
        options:
          - release      # æ­£å¼å‘å¸ƒ
          - prerelease   # é¢„å‘å¸ƒ
          - test         # æµ‹è¯•ç‰ˆæœ¬

# ä¸Šä¼ ä½œä¸š - ä½¿ç”¨çŸ©é˜µç­–ç•¥æž„å»ºä¸¤ä¸ªAPKå˜ä½“
jobs:
  upload:
    # çŸ©é˜µç­–ç•¥ï¼šå¹¶è¡Œæž„å»ºä¸¤ä¸ªä¸åŒçš„APKå˜ä½“
    strategy:
      matrix:
        build:
          - name: koishi-android                    # åŸºç¡€ç‰ˆAPK
            copy: copy
          - name: koishi-android-with-chromium      # åŒ…å«Chromiumçš„å®Œæ•´ç‰ˆAPK
            copy: copy-extra
    
    # è¿è¡Œåœ¨Ubuntuæœ€æ–°ç‰ˆæœ¬
    runs-on: ubuntu-latest
    
    # æž„å»ºæ­¥éª¤åºåˆ—
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4  # ä½¿ç”¨æœ€æ–°çš„checkout action

      # æ­¥éª¤2ï¼šè®¾ç½®æ—¥å¿—æ”¶é›†å™¨æƒé™
      - name: Make log collector executable
        run: chmod +x .github/scripts/log-collector.sh  # ä½¿æ—¥å¿—æ”¶é›†è„šæœ¬å¯æ‰§è¡Œ

      # æ­¥éª¤3ï¼šæ”¶é›†ç³»ç»Ÿä¿¡æ¯
      - name: Collect system information
        run: |
          .github/scripts/log-collector.sh collect-system  # æ”¶é›†æž„å»ºçŽ¯å¢ƒä¿¡æ¯

      # æ­¥éª¤4ï¼šè®¾ç½®æž„å»ºå˜é‡
      - name: Set up variables
        id: vars  # è®¾ç½®æ­¥éª¤IDä¾›åŽç»­å¼•ç”¨
        run: |
          echo "::group::Setting up build variables"
          
          # æ ¹æ®è§¦å‘ç±»åž‹è®¾ç½®ä¸åŒçš„å˜é‡
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # Releaseåˆ›å»ºäº‹ä»¶ - ä½¿ç”¨äº‹ä»¶è´Ÿè½½
            TAG="${{ github.event.release.tag_name }}"
            UPLOAD_URL="${{ github.event.release.upload_url }}"
            IS_PRERELEASE="${{ github.event.release.prerelease }}"
            echo "Triggered by release creation: $TAG"
          else
            # æ‰‹åŠ¨è§¦å‘ - ç¡®å®šç›®æ ‡release
            INPUT_TAG="${{ github.inputs.target_release }}"
            BUILD_PURPOSE="${{ github.inputs.build_purpose }}"
            
            # å¦‚æžœæŒ‡å®šäº†ç›®æ ‡æ ‡ç­¾ï¼Œä½¿ç”¨æŒ‡å®šçš„æ ‡ç­¾
            if [[ -n "$INPUT_TAG" ]]; then
              TAG="$INPUT_TAG"
            else
              # èŽ·å–æœ€æ–°çš„release
              LATEST_RELEASE=$(curl \
                -sS \
                -H 'Accept: application/vnd.github.v3+json' \
                -H 'Authorization: token ${{ github.token }}' \
                https://api.github.com/repos/${{ github.repository }}/releases/latest)
              TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
            fi
            
            # å¯¹äºŽæ‰‹åŠ¨è§¦å‘ï¼Œéœ€è¦æž„é€ upload_url
            UPLOAD_URL="https://uploads.github.com/repos/${{ github.repository }}/releases"
            
            # æ ¹æ®è¾“å…¥è®¾ç½®é¢„å‘å¸ƒæ ‡å¿—
            if [[ "$BUILD_PURPOSE" == "prerelease" ]]; then
              IS_PRERELEASE=true
            elif [[ "$BUILD_PURPOSE" == "test" ]]; then
              IS_PRERELEASE=true
            else
              IS_PRERELEASE=false
            fi
            
            echo "Manual trigger - target: $TAG, purpose: $BUILD_PURPOSE"
          fi
          
          # è¾“å‡ºå˜é‡åˆ°GitHub Actions
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "UPLOAD_URL=$UPLOAD_URL" >> $GITHUB_OUTPUT
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      # æ­¥éª¤5ï¼šéªŒè¯releaseå­˜åœ¨ï¼ˆä»…æ‰‹åŠ¨è§¦å‘æ—¶ï¼‰
      - name: Validate release exists
        if: github.event_name == 'workflow_dispatch'  # ä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶æ‰§è¡Œ
        run: |
          echo "::group::Validating release exists"
          
          VALIDATION_RESULT=$(./.github/scripts/log-collector.sh execute "validate-release" "
            TAG='${{ steps.vars.outputs.TAG }}'
            
            # æ£€æŸ¥releaseæ˜¯å¦å­˜åœ¨
            RELEASE_INFO=\$(curl \
              -sS \
              -H 'Accept: application/vnd.github.v3+json' \
              -H 'Authorization: token ${{ github.token }}' \
              https://api.github.com/repos/${{ github.repository }}/releases/tags/\$TAG)
            
            if [[ \$(echo \"\$RELEASE_INFO\" | jq -r '.message') == \"Not Found\" ]]; then
              echo \"âŒ Release \$TAG not found. Please create the release first.\"
              exit 1
            fi
            
            UPLOAD_URL=\$(echo \"\$RELEASE_INFO\" | jq -r '.upload_url' | cut -d'{' -f1)
            echo \"UPLOAD_URL=\$UPLOAD_URL\" >> \$GITHUB_OUTPUT
            echo \"âœ… Found release: \$TAG\"
          ")
          
          # è§£æžéªŒè¯ç»“æžœ - log-collector.shè¿”å›žæ ¼å¼: EXIT_CODE:LOG_FILE
          EXIT_CODE=${VALIDATION_RESULT%%:*}
          LOG_FILE=${VALIDATION_RESULT##*:}
          
          # æ£€æŸ¥éªŒè¯ç»“æžœ
          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "âŒ Release validation failed"
            echo "ðŸ“‹ Check log file: $LOG_FILE"
            exit 1
          fi
          
          echo "âœ… Release validation successful"
          echo "::endgroup::"

      # æ­¥éª¤6ï¼šå®‰è£…NixåŒ…ç®¡ç†å™¨
      - name: Install nix with logging
        run: |
          echo "::group::Installing Nix"
          .github/scripts/log-collector.sh execute "install-nix" "uses cachix/install-nix-action@v20"
          echo "::endgroup::"

      # æ­¥éª¤7ï¼šè®¾ç½®Cachixç¼“å­˜
      - name: setup cachix with logging
        uses: cachix/cachix-action@v12
        with:
          name: koishi
          authToken: ${{ secrets.CACHIX_TOKEN }}

      # æ­¥éª¤8ï¼šè®¾ç½®JavaçŽ¯å¢ƒ
      - name: Setup Java with logging
        uses: actions/setup-java@v4
        with:
          distribution: temurin    # ä½¿ç”¨Temurinå‘è¡Œç‰ˆ
          java-version: '11'       # Java 11ç‰ˆæœ¬
          cache: gradle            # å¯ç”¨Gradleç¼“å­˜

      # æ­¥éª¤9ï¼šæ‰§è¡Œæž„å»º
      - name: Build with comprehensive logging
        run: |
          echo "::group::Building ${{ matrix.build.name }}"
          
          TAG="${{ steps.vars.outputs.TAG }}"
          BUILD_PURPOSE="${{ github.inputs.build_purpose || 'release' }}"
          
          # æ ¹æ®ä¸åŒæž„å»ºç±»åž‹è°ƒæ•´ç‰ˆæœ¬ä»£ç 
          BASE_VERSION_CODE=$(echo "${TAG:1}" | sed 's/\.//g')
          
          case "$BUILD_PURPOSE" in
            "prerelease")
              VERSION_CODE="9${BASE_VERSION_CODE}"  # 9xxx ç”¨äºŽé¢„å‘å¸ƒ
              ;;
            "test")
              VERSION_CODE="8${BASE_VERSION_CODE}"  # 8xxx ç”¨äºŽæµ‹è¯•
              ;;
            *)
              VERSION_CODE="${BASE_VERSION_CODE}"   # æ­£å¸¸ç”¨äºŽå‘å¸ƒ
              ;;
          esac
          
          # ä½¿ç”¨æ—¥å¿—æ”¶é›†å™¨æ‰§è¡Œæž„å»º
          BUILD_RESULT=$(./.github/scripts/log-collector.sh execute "build-${{ matrix.build.copy }}" "
            export VERSION_CODE='$VERSION_CODE'
            export VERSION_NAME='$TAG'
            export COPY='${{ matrix.build.copy }}'
            
            echo \"Building ${{ matrix.build.name }} with VERSION_CODE=\$VERSION_CODE\"
            ./build.sh
          ")
          
          # è§£æžæž„å»ºç»“æžœ - log-collector.shè¿”å›žæ ¼å¼: EXIT_CODE:LOG_FILE
          EXIT_CODE=${BUILD_RESULT%%:*}
          LOG_FILE=${BUILD_RESULT##*:}
          
          # æ£€æŸ¥æž„å»ºç»“æžœ
          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "âŒ Build failed for ${{ matrix.build.name }} (exit code: $EXIT_CODE)"
            echo "ðŸ“‹ Check log file: $LOG_FILE"
            exit 1
          fi
          
          echo "âœ… Build completed for ${{ matrix.build.name }}"
          echo "::endgroup::"

      # æ­¥éª¤10ï¼šå‡†å¤‡APKç­¾åï¼ˆçŽ¯å¢ƒè®¾ç½®ï¼‰
      - name: Sign APK with logging
        id: sign_app  # è®¾ç½®æ­¥éª¤IDç”¨äºŽè¾“å‡ºå¼•ç”¨
        run: |
          echo "::group::Signing ${{ matrix.build.name }}"
          
          SIGN_RESULT=$(./.github/scripts/log-collector.sh execute "sign-${{ matrix.build.copy }}" "
            echo \"Setting up signing environment for ${{ matrix.build.name }}...\"
            echo \"Key alias: koishi-android\"
            echo \"Signing key configured: ***\"
            echo \"Keystore password configured: ***\"
            echo \"Key password configured: ***\"
          ")
          
          # æ³¨æ„ï¼šä¸Šé¢çš„æ—¥å¿—è®°å½•çŽ¯å¢ƒè®¾ç½®ï¼Œå®žé™…ç­¾åç”±actionæ‰§è¡Œ
          echo "::endgroup::"

      # æ­¥éª¤11ï¼šå®žé™…æ‰§è¡ŒAPKç­¾å
      - name: Sign app APK (actual)
        id: signer  # ä¿®å¤ï¼šä½¿ç”¨æ›´æ¸…æ™°çš„ID
        uses: ilharp/sign-android-release@v1
        with:
          keyAlias: koishi-android
          signingKey: ${{ secrets.JKS }}
          keyStorePassword: ${{ secrets.JKS_PASSWORD }}
          keyPassword: ${{ secrets.JKS_PASSWORD }}

      # æ­¥éª¤12ï¼šéªŒè¯ç­¾åæ–‡ä»¶
      - name: Verify signed APK
        run: |
          echo "::group::Verifying signed APK"
          # æŸ¥æ‰¾ç­¾ååŽçš„APKæ–‡ä»¶
          SIGNED_APK=$(find signed-artifacts -name "*.apk" 2>/dev/null | head -1)
          if [[ -z "$SIGNED_APK" ]]; then
            echo "âŒ No signed APK found in signed-artifacts/"
            ls -la signed-artifacts/ 2>/dev/null || echo "signed-artifacts directory not found"
            exit 1
          fi
          echo "âœ… Found signed APK: $SIGNED_APK"
          echo "signed_apk_path=$SIGNED_APK" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      # æ­¥éª¤13ï¼šä¸Šä¼ åˆ°Release
      - name: Upload to Release with logging
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.inputs.build_purpose != 'test')
        run: |
          echo "::group::Uploading ${{ matrix.build.name }} to Release"
          
          # å‡†å¤‡æ–‡ä»¶åï¼Œæ·»åŠ æž„å»ºç›®çš„åŽç¼€
          BUILD_PURPOSE="${{ github.inputs.build_purpose || 'release' }}"
          TAG="${{ steps.vars.outputs.TAG }}"
          FILENAME="${{ matrix.build.name }}-${TAG}"
          
          # ä¸ºéžå‘å¸ƒæž„å»ºæ·»åŠ åŽç¼€
          if [[ "$BUILD_PURPOSE" == "prerelease" ]]; then
            FILENAME="${FILENAME}-pre"
          elif [[ "$BUILD_PURPOSE" == "test" ]]; then
            FILENAME="${FILENAME}-test"
          fi
          
          FILENAME="${FILENAME}.apk"
          ENCODED_NAME=$(printf "%s" "$FILENAME" | jq -sRr @uri)  # URLç¼–ç æ–‡ä»¶å
          
          echo "Uploading: $FILENAME"
          
          # ä½¿ç”¨æ—¥å¿—æ”¶é›†å™¨æ‰§è¡Œä¸Šä¼ 
          UPLOAD_RESULT=$(./.github/scripts/log-collector.sh execute "upload-${{ matrix.build.copy }}" "
            # ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶è·¯å¾„å¼•ç”¨
            SIGNED_APK='${{ steps.signer.outputs.signedFile }}'
            if [[ -z \"\$SIGNED_APK\" ]]; then
              # å¦‚æžœactionæ²¡æœ‰è¾“å‡ºsignedFileï¼Œä½¿ç”¨æŸ¥æ‰¾çš„æ–‡ä»¶
              SIGNED_APK=\$(find signed-artifacts -name '*.apk' 2>/dev/null | head -1)
            fi
            
            if [[ -z \"\$SIGNED_APK\" ]] || [[ ! -f \"\$SIGNED_APK\" ]]; then
              echo 'âŒ Signed APK file not found'
              exit 1
            fi
            
            echo \"Uploading file: \$SIGNED_APK\"
            
            UPLOAD_RESPONSE=\$(curl -s \
              -X POST \
              -H 'Accept: application/vnd.github.v3+json' \
              -H 'Content-Type: application/octet-stream' \
              -H 'Authorization: token ${{ github.token }}' \
              --data-binary @\"\$SIGNED_APK\" \
              \"${{ steps.vars.outputs.UPLOAD_URL }}?name=${ENCODED_NAME}\")
            
            # æ£€æŸ¥ä¸Šä¼ ç»“æžœ
            BROWSER_URL=\$(echo \"\$UPLOAD_RESPONSE\" | jq -r '.browser_download_url')
            if [[ \"\$BROWSER_URL\" == \"\" ]] || [[ -z \"\$BROWSER_URL\" ]]; then
              echo \"âŒ Upload failed\"
              echo \"Response: \$UPLOAD_RESPONSE\"
              exit 1
            fi
            
            echo \"âœ… Uploaded successfully: \$BROWSER_URL\"
            echo \"browser_url=\$BROWSER_URL\" >> \$GITHUB_OUTPUT
          ")
          
          # è§£æžä¸Šä¼ ç»“æžœ - log-collector.shè¿”å›žæ ¼å¼: EXIT_CODE:LOG_FILE
          EXIT_CODE=${UPLOAD_RESULT%%:*}
          LOG_FILE=${UPLOAD_RESULT##*:}
          
          # æ£€æŸ¥ä¸Šä¼ ç»“æžœ
          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "âŒ Upload failed for ${{ matrix.build.name }}"
            echo "ðŸ“‹ Check log file: $LOG_FILE"
            exit 1
          fi
          
          echo "âœ… ${{ matrix.build.name }} uploaded successfully"
          echo "::endgroup::"

      # æ­¥éª¤14ï¼šä¸Šä¼ ä¸ºArtifactï¼ˆæµ‹è¯•æž„å»ºï¼‰
      - name: Upload as Artifact (for test builds)
        if: github.event_name == 'workflow_dispatch' && github.inputs.build_purpose == 'test'
        uses: actions/upload-artifact@v4
        with:
          name: test-${{ matrix.build.name }}-${{ steps.vars.outputs.TAG }}
          path: |
            signed-artifacts/*.apk  # ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„è·¯å¾„æ¨¡å¼
          retention-days: 7

      # æ­¥éª¤15ï¼šå‡†å¤‡æ—¥å¿—ä¸Šä¼ 
      - name: Prepare logs for upload
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        id: prepare_upload_logs  # æ·»åŠ æ­¥éª¤IDç”¨äºŽè¾“å‡ºå¼•ç”¨
        run: |
          BUILD_STATUS="${{ job.status }}"
          if [[ "$BUILD_STATUS" == "success" ]]; then
            BUILD_STATUS="SUCCESS"
          else
            BUILD_STATUS="FAILURE"
          fi
          
          .github/scripts/log-collector.sh summary "$BUILD_STATUS"
          .github/scripts/log-collector.sh upload "upload-logs-${{ matrix.build.name }}-${{ steps.vars.outputs.TAG }}"

      # æ­¥éª¤16ï¼šä¸Šä¼ æž„å»ºæ—¥å¿—
      - name: Upload build logs
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.prepare_upload_logs.outputs.artifact_name }}  # ä¿®å¤ï¼šå¼•ç”¨æ­£ç¡®çš„æ­¥éª¤ID
          path: ${{ steps.prepare_upload_logs.outputs.archive_path }}    # ä¿®å¤ï¼šå¼•ç”¨æ­£ç¡®çš„æ­¥éª¤ID
          retention-days: 30
          if-no-files-found: warn

      # æ­¥éª¤17ï¼šç”Ÿæˆæž„å»ºæ‘˜è¦
      - name: Build Summary
        run: |
          echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Variant:** ${{ matrix.build.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.vars.outputs.TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "**Purpose:** ${{ github.inputs.build_purpose || 'release' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ ¹æ®æž„å»ºç±»åž‹æ˜¾ç¤ºä¸åŒçš„ä¿¡æ¯
          if [[ "${{ github.event_name }}" == "release" ]] || [[ "${{ github.inputs.build_purpose }}" != "test" ]]; then
            echo "### âœ… Uploaded to Release" >> $GITHUB_STEP_SUMMARY
            echo "APK has been uploaded to the GitHub Release page." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“¦ Available as Artifact" >> $GITHUB_STEP_SUMMARY
            echo "APK is available for download from the Actions artifacts." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Logs" >> $GITHUB_STEP_SUMMARY
          echo "Complete build logs are available as artifacts with all sensitive information filtered." >> $GITHUB_STEP_SUMMARY
          echo "Download the logs artifact for detailed debugging information." >> $GITHUB_STEP_SUMMARY