# ============================================
# Koishi Android æµ‹è¯•æž„å»ºå·¥ä½œæµ
# 
# åŠŸèƒ½è¯´æ˜Žï¼š
# - ä¸ºAndroidåº”ç”¨æ‰§è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•æž„å»º
# - æ”¯æŒå¤šç§æž„å»ºç±»åž‹ï¼štestã€previewã€rc
# - ç”Ÿæˆä¸¤ä¸ªAPKå˜ä½“ï¼šåŸºç¡€ç‰ˆå’ŒåŒ…å«Chromiumçš„å®Œæ•´ç‰ˆ
# - æ‰§è¡ŒåŸºæœ¬çš„APKéªŒè¯æµ‹è¯•
# - ä¸Šä¼ æž„å»ºäº§ç‰©å’Œæ—¥å¿—åˆ°GitHub Actions artifacts
#
# è§¦å‘æ¡ä»¶ï¼š
# - æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰ï¼šæ”¯æŒè‡ªå®šä¹‰æž„å»ºå‚æ•°
# - PRäº‹ä»¶ï¼šå½“ä¿®æ”¹legacyã€build.shæˆ–workflowæ–‡ä»¶æ—¶
# - æŽ¨é€äº‹ä»¶ï¼šæŽ¨é€åˆ°android-fixesæˆ–developåˆ†æ”¯æ—¶
#
# ä½œè€…ï¼šKoishi Androidå¼€å‘å›¢é˜Ÿ
# æ›´æ–°æ—¥æœŸï¼š2024-12-16
# ç‰ˆæœ¬ï¼š2025-12-17 (ä¿®å¤Nixå®‰è£…åˆ°v31)
# ============================================

# å·¥ä½œæµæƒé™é…ç½®
permissions:
  contents: read        # å…è®¸è¯»å–ä»“åº“å†…å®¹
  packages: read        # å…è®¸è¯»å–åŒ…ä¿¡æ¯
  actions: read         # å…è®¸è¯»å–å·¥ä½œæµè¿è¡Œä¿¡æ¯ç”¨äºŽartifacts

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # æ‰‹åŠ¨è§¦å‘ - æ”¯æŒè‡ªå®šä¹‰æž„å»ºå‚æ•°
  workflow_dispatch:
    inputs:
      # æž„å»ºç±»åž‹é€‰æ‹©
      build_type:
        description: 'æž„å»ºç±»åž‹'
        required: true
        default: 'test'
        type: choice
        options:
          - test      # æµ‹è¯•æž„å»º
          - preview   # é¢„è§ˆæž„å»º
          - rc        # å‘å¸ƒå€™é€‰ç‰ˆæœ¬
      # ç‰ˆæœ¬åŽç¼€
      version_suffix:
        description: 'ç‰ˆæœ¬åŽç¼€ (ä¾‹å¦‚: beta1, rc2)'
        required: false
        default: ''
        type: string
      # æ˜¯å¦ä¸Šä¼ æž„å»ºäº§ç‰©
      upload_artifacts:
        description: 'ä¸Šä¼ æž„å»ºäº§ç‰©'
        required: true
        default: true
        type: boolean
  
  # PRäº‹ä»¶è§¦å‘ - å½“ç›¸å…³æ–‡ä»¶å˜æ›´æ—¶
  pull_request:
    types: [opened, synchronize, reopened]  # PRæ‰“å¼€ã€åŒæ­¥ã€é‡æ–°æ‰“å¼€
    paths:  # ç›‘æŽ§çš„æ–‡ä»¶è·¯å¾„
      - 'legacy/**'          # legacyç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
      - 'build.sh'           # æž„å»ºè„šæœ¬
      - '.github/workflows/**'  # å·¥ä½œæµæ–‡ä»¶
  
  # æŽ¨é€äº‹ä»¶è§¦å‘ - ç‰¹å®šåˆ†æ”¯
  push:
    branches:  # ç›‘æŽ§çš„åˆ†æ”¯
      - android-fixes   # Androidä¿®å¤åˆ†æ”¯
      - develop         # å¼€å‘åˆ†æ”¯
    paths:  # ç›‘æŽ§çš„æ–‡ä»¶è·¯å¾„
      - 'legacy/**'
      - 'build.sh'
      - '.github/workflows/**'

# å¹¶å‘æŽ§åˆ¶é…ç½®
concurrency:
  # å¹¶å‘ç»„åç§°ï¼šå·¥ä½œæµå-åˆ†æ”¯-æž„å»ºç±»åž‹
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.inputs.build_type || 'auto' }}
  # å…è®¸å–æ¶ˆè¿›è¡Œä¸­çš„æž„å»º
  cancel-in-progress: true

# ä¸»è¦æž„å»ºä½œä¸š
jobs:
  test-build:
    # è¿è¡Œåœ¨Ubuntuæœ€æ–°ç‰ˆæœ¬
    runs-on: ubuntu-latest
    
    # ä½œä¸šè¾“å‡º - ä¾›åŽç»­ä½œä¸šä½¿ç”¨
    outputs:
      version_name: ${{ steps.version.outputs.version_name }}    # ç‰ˆæœ¬åç§°
      version_code: ${{ steps.version.outputs.version_code }}    # ç‰ˆæœ¬ä»£ç 
      build_success: ${{ steps.build.outcome }}                  # æž„å»ºæˆåŠŸçŠ¶æ€
    
    # æž„å»ºæ­¥éª¤åºåˆ—
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4  # ä½¿ç”¨æœ€æ–°çš„checkout action

      # æ­¥éª¤2ï¼šè®¾ç½®æ—¥å¿—æ”¶é›†å™¨æƒé™
      - name: Make log collector executable
        run: chmod +x .github/scripts/log-collector.sh  # ä½¿æ—¥å¿—æ”¶é›†è„šæœ¬å¯æ‰§è¡Œ

      # æ­¥éª¤3ï¼šæ”¶é›†ç³»ç»Ÿä¿¡æ¯
      - name: Collect system information
        run: |
          .github/scripts/log-collector.sh collect-system  # æ”¶é›†æž„å»ºçŽ¯å¢ƒä¿¡æ¯

      # æ­¥éª¤4ï¼šç”Ÿæˆæµ‹è¯•ç‰ˆæœ¬ä¿¡æ¯
      - name: Generate test version
        id: version  # ä¸ºæ­¤æ­¥éª¤è®¾ç½®IDï¼Œä¾›åŽç»­å¼•ç”¨
        run: |
          # æ ¹æ®è§¦å‘ç±»åž‹ç”Ÿæˆä¸åŒçš„ç‰ˆæœ¬ä¿¡æ¯
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PRæž„å»ºï¼šä½¿ç”¨PRç¼–å·
            PR_NUM="${{ github.event.pull_request.number }}"
            VERSION_NAME="test-pr${PR_NUM}"
            VERSION_CODE="900${PR_NUM}"  # 9000+ åŒºåˆ†æ­£å¼ç‰ˆæœ¬
          elif [[ "${{ github.ref }}" == "refs/heads/android-fixes" ]]; then
            # åˆ†æ”¯æž„å»ºï¼šä½¿ç”¨æäº¤çŸ­å“ˆå¸Œ
            COMMIT_SHA="${{ github.sha }}"
            SHORT_SHA="${COMMIT_SHA:0:7}"
            VERSION_NAME="test-fixes-${SHORT_SHA}"
            VERSION_CODE="800${COMMIT_SHA: -4}"  # 8000+ ç”¨äºŽåˆ†æ”¯æž„å»º
          else
            # æ‰‹åŠ¨æž„å»ºï¼šä½¿ç”¨è¾“å…¥å‚æ•°æˆ–æ—¶é—´æˆ³
            BUILD_TYPE="${{ github.inputs.build_type || 'test' }}"
            SUFFIX="${{ github.inputs.version_suffix }}"
            TIMESTAMP=$(date +%Y%m%d%H%M)
            
            if [[ -n "$SUFFIX" ]]; then
              VERSION_NAME="${BUILD_TYPE}-${TIMESTAMP}-${SUFFIX}"
            else
              VERSION_NAME="${BUILD_TYPE}-${TIMESTAMP}"
            fi
            VERSION_CODE="7${TIMESTAMP: -4}"  # 7000+ ç”¨äºŽæ‰‹åŠ¨æž„å»º
          fi
          
          # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯åˆ°GitHub Actionsè¾“å‡º
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION_NAME (code: $VERSION_CODE)"

      # æ­¥éª¤5ï¼šå®‰è£…NixåŒ…ç®¡ç†å™¨ (ä¿®å¤åˆ°v31)
      - name: Install nix with logging
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤6ï¼šè®¾ç½®Cachixç¼“å­˜ (ä¿®å¤åˆ°v16)
      - name: Setup cachix with logging
        uses: cachix/cachix-action@v16
        with:
          name: koishi
          authToken: ${{ secrets.CACHIX_TOKEN }}

      # æ­¥éª¤7ï¼šè®¾ç½®JavaçŽ¯å¢ƒ
      - name: Setup Java with logging
        uses: actions/setup-java@v4
        with:
          distribution: temurin    # ä½¿ç”¨Temurinå‘è¡Œç‰ˆ
          java-version: '11'       # Java 11ç‰ˆæœ¬
          cache: gradle            # å¯ç”¨Gradleç¼“å­˜

      # æ­¥éª¤8ï¼šæž„å»ºæµ‹è¯•APK
      - name: Build test APKs with logging
        id: build  # è®¾ç½®æ­¥éª¤IDç”¨äºŽè¾“å‡ºå¼•ç”¨
        run: |
          echo "Building test version: ${{ steps.version.outputs.version_name }}"
          
          # æž„å»ºä¸¤ä¸ªå˜ä½“è¿›è¡Œæµ‹è¯•
          for COPY_TYPE in copy copy-extra; do
            echo "::group::Building with COPY=$COPY_TYPE"
            
            # ä½¿ç”¨æ—¥å¿—æ”¶é›†å™¨æ‰§è¡Œæž„å»º
            BUILD_RESULT=$(./.github/scripts/log-collector.sh execute "build-$COPY_TYPE" "
              export VERSION_CODE='${{ steps.version.outputs.version_code }}'
              export VERSION_NAME='${{ steps.version.outputs.version_name }}'
              export COPY='$COPY_TYPE'
              ./build.sh
            ")
            
            # è§£æžæž„å»ºç»“æžœ
            EXIT_CODE=${BUILD_RESULT%%:*}
            LOG_FILE=${BUILD_RESULT##*:}
            
            # æ£€æŸ¥æž„å»ºç»“æžœ
            if [[ $EXIT_CODE -ne 0 ]]; then
              echo "âŒ Build failed for COPY=$COPY_TYPE (exit code: $EXIT_CODE)"
              echo "ðŸ“‹ Check log file: $LOG_FILE"
              exit 1
            fi
            
            echo "âœ… Build completed for COPY=$COPY_TYPE"
            
            # å°†APKç§»åŠ¨åˆ°å¯åŒºåˆ†çš„ä½ç½®
            if [[ "$COPY_TYPE" == "copy" ]]; then
              mkdir -p test-artifacts
              find app/build -name "*.apk" -not -path "*/test/*" -not -path "*/debug/*" | head -1 | xargs -I {} cp {} test-artifacts/koishi-android-${{ steps.version.outputs.version_name }}.apk
            else
              find app/build -name "*.apk" -not -path "*/test/*" -not -path "*/debug/*" | head -1 | xargs -I {} cp {} test-artifacts/koishi-android-with-chromium-${{ steps.version.outputs.version_name }}.apk
            fi
            
            echo "::endgroup::"
          done
          
          echo "âœ… Test builds completed successfully"

      # æ­¥éª¤9ï¼šå‡†å¤‡APKç­¾åï¼ˆçŽ¯å¢ƒè®¾ç½®ï¼‰
      - name: Sign test APKs with logging
        if: github.inputs.upload_artifacts == 'true' || github.event_name != 'workflow_dispatch'
        run: |
          echo "::group::Signing APKs"
          SIGN_RESULT=$(./.github/scripts/log-collector.sh execute "sign-apks" "
            uses ilharp/sign-android-release@v1
            with:
              keyAlias: koishi-android
              signingKey: ${{ secrets.JKS }}
              keyStorePassword: ${{ secrets.JKS_PASSWORD }}
              keyPassword: ${{ secrets.JKS_PASSWORD }}
              inputFiles: test-artifacts/*.apk
              outputFiles: signed-artifacts/
          ")
          
          # æ³¨æ„ï¼šä¸Šé¢çš„é…ç½®ä¸ä¼šç›´æŽ¥ä¸ŽGitHub Actionsä¸€èµ·å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æŽ¥ä½¿ç”¨action
          # ä½†è®°å½•çŽ¯å¢ƒè®¾ç½®
          echo "Setting up signing environment..."
          echo "Key alias: koishi-android"
          echo "Signing key configured: ***"
          echo "Keystore password configured: ***"
          echo "Key password configured: ***"
          echo "::endgroup::"

      # æ­¥éª¤10ï¼šå®žé™…æ‰§è¡ŒAPKç­¾å
      - name: Sign test APKs (actual)
        if: github.inputs.upload_artifacts == 'true' || github.event_name != 'workflow_dispatch'
        id: sign_apks  # æ·»åŠ æ­¥éª¤IDç”¨äºŽè¾“å‡ºå¼•ç”¨
        uses: ilharp/sign-android-release@v1
        with:
          keyAlias: koishi-android
          signingKey: ${{ secrets.JKS }}
          keyStorePassword: ${{ secrets.JKS_PASSWORD }}
          keyPassword: ${{ secrets.JKS_PASSWORD }}
          inputFiles: test-artifacts/*.apk
          outputFiles: signed-artifacts/

      # æ­¥éª¤11ï¼šä¸Šä¼ æµ‹è¯•æž„å»ºäº§ç‰©
      - name: Upload test artifacts
        if: github.inputs.upload_artifacts == 'true' || github.event_name != 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: test-apks-${{ steps.version.outputs.version_name }}
          path: signed-artifacts/
          retention-days: 30
          if-no-files-found: error

      # æ­¥éª¤12ï¼šå‡†å¤‡æ—¥å¿—ä¸Šä¼ 
      - name: Prepare logs for upload
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        id: prepare_logs  # æ·»åŠ æ­¥éª¤ID
        run: |
          .github/scripts/log-collector.sh summary "${{ steps.build.outcome || 'failure' }}"
          .github/scripts/log-collector.sh upload "test-build-logs-${{ steps.version.outputs.version_name }}"

      # æ­¥éª¤13ï¼šä¸Šä¼ æž„å»ºæ—¥å¿—
      - name: Upload build logs
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.prepare_logs.outputs.artifact_name }}  # ä¿®å¤ï¼šå¼•ç”¨æ­£ç¡®çš„æ­¥éª¤ID
          path: ${{ steps.prepare_logs.outputs.archive_path }}    # ä¿®å¤ï¼šå¼•ç”¨æ­£ç¡®çš„æ­¥éª¤ID
          retention-days: 30
          if-no-files-found: warn

      # æ­¥éª¤14ï¼šç”Ÿæˆæž„å»ºæ‘˜è¦
      - name: Build summary
        run: |
          echo "## ðŸ§ª Test Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version Code:** ${{ steps.version.outputs.version_code }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type:** ${{ github.inputs.build_type || 'auto' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Built Variants:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… koishi-android (basic)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… koishi-android-with-chromium (full)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download:" >> $GITHUB_STEP_SUMMARY
          echo "- **APKs:** Available in the Actions tab for 30 days" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Logs:** Available as artifact with all sensitive data filtered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Debugging:" >> $GITHUB_STEP_SUMMARY
          echo "If build failed, download the build logs artifact for detailed information." >> $GITHUB_STEP_SUMMARY
          echo "All sensitive information (tokens, passwords, keys) has been filtered from logs." >> $GITHUB_STEP_SUMMARY

  # åŸºç¡€æµ‹è¯•ä½œä¸š - éªŒè¯æž„å»ºçš„APK
  basic-tests:
    runs-on: ubuntu-latest
    needs: test-build  # ä¾èµ–ä¸»æž„å»ºä½œä¸š
    if: needs.test-build.outputs.build_success == 'success'  # ä»…åœ¨æž„å»ºæˆåŠŸæ—¶è¿è¡Œ
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šè®¾ç½®æ—¥å¿—æ”¶é›†å™¨æƒé™
      - name: Make log collector executable
        run: chmod +x .github/scripts/log-collector.sh

      # æ­¥éª¤3ï¼šä¸‹è½½æž„å»ºäº§ç‰©
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-apks-${{ needs.test-build.outputs.version_name }}
          path: downloaded-apks/

      # æ­¥éª¤4ï¼šæ‰§è¡ŒAPKåŸºç¡€éªŒè¯
      - name: Basic APK validation with logging
        run: |
          echo "::group::Validating APKs"
          VALIDATION_RESULT=$(./.github/scripts/log-collector.sh execute "apk-validation" "
            echo 'ðŸ” Validating APKs...'
            
            # æ£€æŸ¥APKæ˜¯å¦å­˜åœ¨ä¸”å¤§å°åˆç†
            for apk in downloaded-apks/*.apk; do
              if [[ -f \"\$apk\" ]]; then
                size=$(stat -f%z \"\$apk\" 2>/dev/null || stat -c%s \"\$apk\" 2>/dev/null)
                filename=$(basename \"\$apk\")
                
                echo \"ðŸ“¦ \$filename: \${size} bytes\"
                
                # åŸºç¡€å¤§å°æ£€æŸ¥ï¼ˆåŠŸèƒ½æ­£å¸¸çš„APKè‡³å°‘1MBï¼‰
                if [[ $size -lt 1048576 ]]; then
                  echo \"âŒ APK too small: \$filename (\${size} bytes)\"
                  exit 1
                fi
                
                # æ£€æŸ¥æ˜¯å¦ä¸ºçœŸæ­£çš„APKï¼ˆZIPæ ¼å¼ï¼‰
                if ! file \"\$apk\" | grep -q \"Zip archive\"; then
                  echo \"âŒ Invalid APK format: \$filename\"
                  exit 1
                fi
              else
                echo \"âŒ APK file not found: \$apk\"
                exit 1
              fi
            done
            
            echo \"âœ… All APKs passed basic validation\"
          ")
          
          # è§£æžéªŒè¯ç»“æžœ
          EXIT_CODE=${VALIDATION_RESULT%%:*}
          LOG_FILE=${VALIDATION_RESULT##*:}
          
          # æ£€æŸ¥éªŒè¯ç»“æžœ
          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "âŒ APK validation failed (exit code: $EXIT_CODE)"
            exit 1
          fi
          
          echo "âœ… All APKs passed basic validation"
          echo "::endgroup::"

      # æ­¥éª¤5ï¼šå‡†å¤‡éªŒè¯æ—¥å¿—
      - name: Prepare validation logs
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        id: prepare_validation_logs  # æ·»åŠ æ­¥éª¤IDç”¨äºŽè¾“å‡ºå¼•ç”¨
        run: |
          .github/scripts/log-collector.sh summary "${{ job.status }}"
          .github/scripts/log-collector.sh upload "validation-logs-${{ needs.test-build.outputs.version_name }}"

      # æ­¥éª¤6ï¼šä¸Šä¼ éªŒè¯æ—¥å¿—
      - name: Upload validation logs
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.prepare_validation_logs.outputs.artifact_name }}  # ä¿®å¤ï¼šå¼•ç”¨æ­£ç¡®çš„æ­¥éª¤ID
          path: ${{ steps.prepare_validation_logs.outputs.archive_path }}    # ä¿®å¤ï¼šå¼•ç”¨æ­£ç¡®çš„æ­¥éª¤ID
          retention-days: 30
          if-no-files-found: warn

      # æ­¥éª¤7ï¼šç”ŸæˆéªŒè¯æ‘˜è¦
      - name: Test summary
        run: |
          echo "## âœ… Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All APKs passed basic validation checks:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… File format validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Size validation (> 1MB)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… APK structure validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download artifacts for manual testing" >> $GITHUB_STEP_SUMMARY
          echo "2. If tests pass, proceed with release creation" >> $GITHUB_STEP_SUMMARY
          echo "3. Check build logs if any issues occur" >> $GITHUB_STEP_SUMMARY