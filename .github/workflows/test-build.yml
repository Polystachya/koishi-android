permissions:
  contents: read
  packages: read
  actions: read  # Allow reading workflow runs for artifacts

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - preview
          - rc
      version_suffix:
        description: 'Version suffix (e.g., beta1, rc2)'
        required: false
        default: ''
        type: string
      upload_artifacts:
        description: 'Upload build artifacts'
        required: true
        default: true
        type: boolean
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'legacy/**'
      - 'build.sh'
      - '.github/workflows/**'
  push:
    branches:
      - android-fixes
      - develop
    paths:
      - 'legacy/**'
      - 'build.sh'
      - '.github/workflows/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.inputs.build_type || 'auto' }}
  cancel-in-progress: true

jobs:
  test-build:
    runs-on: ubuntu-latest
    outputs:
      version_name: ${{ steps.version.outputs.version_name }}
      version_code: ${{ steps.version.outputs.version_code }}
      build_success: ${{ steps.build.outcome }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make log collector executable
        run: chmod +x .github/scripts/log-collector.sh

      - name: Collect system information
        run: |
          .github/scripts/log-collector.sh collect-system

      - name: Generate test version
        id: version
        run: |
          # Generate version based on trigger type and inputs
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PR builds: use PR number
            PR_NUM="${{ github.event.pull_request.number }}"
            VERSION_NAME="test-pr${PR_NUM}"
            VERSION_CODE="900${PR_NUM}"  # 9000+ to distinguish from releases
          elif [[ "${{ github.ref }}" == "refs/heads/android-fixes" ]]; then
            # Branch builds: use commit short hash
            COMMIT_SHA="${{ github.sha }}"
            SHORT_SHA="${COMMIT_SHA:0:7}"
            VERSION_NAME="test-fixes-${SHORT_SHA}"
            VERSION_CODE="800${COMMIT_SHA: -4}"  # 8000+ for branch builds
          else
            # Manual builds: use input or timestamp
            BUILD_TYPE="${{ github.inputs.build_type || 'test' }}"
            SUFFIX="${{ github.inputs.version_suffix }}"
            TIMESTAMP=$(date +%Y%m%d%H%M)
            
            if [[ -n "$SUFFIX" ]]; then
              VERSION_NAME="${BUILD_TYPE}-${TIMESTAMP}-${SUFFIX}"
            else
              VERSION_NAME="${BUILD_TYPE}-${TIMESTAMP}"
            fi
            VERSION_CODE="7${TIMESTAMP: -4}"  # 7000+ for manual builds
          fi
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION_NAME (code: $VERSION_CODE)"

      - name: Install nix with logging
        run: |
          echo "::group::Installing Nix"
          .github/scripts/log-collector.sh execute "install-nix" "uses cachix/install-nix-action@v20"
          echo "::endgroup::"

      - name: Setup cachix with logging
        uses: cachix/cachix-action@v12
        with:
          name: koishi
          authToken: ${{ secrets.CACHIX_TOKEN }}

      - name: Setup Java with logging
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: gradle

      - name: Build test APKs with logging
        id: build
        run: |
          echo "Building test version: ${{ steps.version.outputs.version_name }}"
          
          # Build both variants for testing
          for COPY_TYPE in copy copy-extra; do
            echo "::group::Building with COPY=$COPY_TYPE"
            
            BUILD_RESULT=$(./.github/scripts/log-collector.sh execute "build-$COPY_TYPE" "
              export VERSION_CODE='${{ steps.version.outputs.version_code }}'
              export VERSION_NAME='${{ steps.version.outputs.version_name }}'
              export COPY='$COPY_TYPE'
              ./build.sh
            ")
            
            EXIT_CODE=${BUILD_RESULT%%:*}
            LOG_FILE=${BUILD_RESULT##*:}
            
            if [[ $EXIT_CODE -ne 0 ]]; then
              echo "âŒ Build failed for COPY=$COPY_TYPE (exit code: $EXIT_CODE)"
              echo "ðŸ“‹ Check log file: $LOG_FILE"
              exit 1
            fi
            
            echo "âœ… Build completed for COPY=$COPY_TYPE"
            
            # Move APK to distinguishable location
            if [[ "$COPY_TYPE" == "copy" ]]; then
              mkdir -p test-artifacts
              find app/build -name "*.apk" -not -path "*/*test*" -not -path "*/*debug*" | head -1 | xargs -I {} cp {} test-artifacts/koishi-android-${{ steps.version.outputs.version_name }}.apk
            else
              find app/build -name "*.apk" -not -path "*/*test*" -not -path "*/*debug*" | head -1 | xargs -I {} cp {} test-artifacts/koishi-android-with-chromium-${{ steps.version.outputs.version_name }}.apk
            fi
            
            echo "::endgroup::"
          done
          
          echo "âœ… Test builds completed successfully"

      - name: Sign test APKs with logging
        if: github.inputs.upload_artifacts == 'true' || github.event_name != 'workflow_dispatch'
        run: |
          echo "::group::Signing APKs"
          SIGN_RESULT=$(./.github/scripts/log-collector.sh execute "sign-apks" "
            uses ilharp/sign-android-release@v1
            with:
              keyAlias: koishi-android
              signingKey: ${{ secrets.JKS }}
              keyStorePassword: ${{ secrets.JKS_PASSWORD }}
              keyPassword: ${{ secrets.JKS_PASSWORD }}
              inputFiles: test-artifacts/*.apk
              outputFiles: signed-artifacts/
          ")
          
          # Note: The above won't work directly with GitHub Actions, so we use the action directly
          # but log the environment setup
          echo "Setting up signing environment..."
          echo "Key alias: koishi-android"
          echo "Signing key configured: ***"
          echo "Keystore password configured: ***"
          echo "Key password configured: ***"
          echo "::endgroup::"

      - name: Sign test APKs (actual)
        if: github.inputs.upload_artifacts == 'true' || github.event_name != 'workflow_dispatch'
        uses: ilharp/sign-android-release@v1
        with:
          keyAlias: koishi-android
          signingKey: ${{ secrets.JKS }}
          keyStorePassword: ${{ secrets.JKS_PASSWORD }}
          keyPassword: ${{ secrets.JKS_PASSWORD }}
          inputFiles: test-artifacts/*.apk
          outputFiles: signed-artifacts/

      - name: Upload test artifacts
        if: github.inputs.upload_artifacts == 'true' || github.event_name != 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: test-apks-${{ steps.version.outputs.version_name }}
          path: signed-artifacts/
          retention-days: 30
          if-no-files-found: error

      - name: Prepare logs for upload
        if: always()
        run: |
          .github/scripts/log-collector.sh summary "${{ steps.build.outcome || 'failure' }}"
          .github/scripts/log-collector.sh upload "test-build-logs-${{ steps.version.outputs.version_name }}"

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.upload.outputs.artifact_name }}
          path: ${{ steps.upload.outputs.archive_path }}
          retention-days: 30
          if-no-files-found: warn

      - name: Build summary
        run: |
          echo "## ðŸ§ª Test Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version Code:** ${{ steps.version.outputs.version_code }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type:** ${{ github.inputs.build_type || 'auto' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Built Variants:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… koishi-android (basic)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… koishi-android-with-chromium (full)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download:" >> $GITHUB_STEP_SUMMARY
          echo "- **APKs:** Available in the Actions tab for 30 days" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Logs:** Available as artifact with all sensitive data filtered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Debugging:" >> $GITHUB_STEP_SUMMARY
          echo "If build failed, download the build logs artifact for detailed information." >> $GITHUB_STEP_SUMMARY
          echo "All sensitive information (tokens, passwords, keys) has been filtered from logs." >> $GITHUB_STEP_SUMMARY

  basic-tests:
    runs-on: ubuntu-latest
    needs: test-build
    if: needs.test-build.outputs.build_success == 'success'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make log collector executable
        run: chmod +x .github/scripts/log-collector.sh

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-apks-${{ needs.test-build.outputs.version_name }}
          path: downloaded-apks/

      - name: Basic APK validation with logging
        run: |
          echo "::group::Validating APKs"
          VALIDATION_RESULT=$(./.github/scripts/log-collector.sh execute "apk-validation" "
            echo 'ðŸ” Validating APKs...'
            
            # Check if APKs exist and have reasonable size
            for apk in downloaded-apks/*.apk; do
              if [[ -f \"\$apk\" ]]; then
                size=\$(stat -f%z \"\$apk\" 2>/dev/null || stat -c%s \"\$apk\" 2>/dev/null)
                filename=\$(basename \"\$apk\")
                
                echo \"ðŸ“¦ \$filename: \${size} bytes\"
                
                # Basic size checks (should be at least 1MB for a functional APK)
                if [[ \$size -lt 1048576 ]]; then
                  echo \"âŒ APK too small: \$filename (\${size} bytes)\"
                  exit 1
                fi
                
                # Check if it's actually an APK (ZIP format)
                if ! file \"\$apk\" | grep -q \"Zip archive\"; then
                  echo \"âŒ Invalid APK format: \$filename\"
                  exit 1
                fi
              else
                echo \"âŒ APK file not found: \$apk\"
                exit 1
              fi
            done
            
            echo \"âœ… All APKs passed basic validation\"
          ")
          
          EXIT_CODE=${VALIDATION_RESULT%%:*}
          LOG_FILE=${VALIDATION_RESULT##*:}
          
          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "âŒ APK validation failed (exit code: $EXIT_CODE)"
            exit 1
          fi
          
          echo "âœ… All APKs passed basic validation"
          echo "::endgroup::"

      - name: Prepare validation logs
        if: always()
        run: |
          .github/scripts/log-collector.sh summary "${{ job.status }}"
          .github/scripts/log-collector.sh upload "validation-logs-${{ needs.test-build.outputs.version_name }}"

      - name: Upload validation logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.upload.outputs.artifact_name }}
          path: ${{ steps.upload.outputs.archive_path }}
          retention-days: 30
          if-no-files-found: warn

      - name: Test summary
        run: |
          echo "## âœ… Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All APKs passed basic validation checks:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… File format validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Size validation (> 1MB)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… APK structure validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download artifacts for manual testing" >> $GITHUB_STEP_SUMMARY
          echo "2. If tests pass, proceed with release creation" >> $GITHUB_STEP_SUMMARY
          echo "3. Check build logs if any issues occur" >> $GITHUB_STEP_SUMMARY