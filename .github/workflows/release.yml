permissions:
  contents: write
  releases: write

concurrency:
  group: release-create
  cancel-in-progress: false

on: workflow_dispatch

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make log collector executable
        run: chmod +x .github/scripts/log-collector.sh

      - name: Collect system information
        run: |
          .github/scripts/log-collector.sh collect-system

      - name: Create release with comprehensive logging
        run: |
          echo "::group::Creating new release"
          
          RELEASE_RESULT=$(./.github/scripts/log-collector.sh execute "create-release" "
            set -euo pipefail
            
            # Get latest release with error handling
            LATEST_RELEASE=\$(curl \
              -sS \
              -H 'Accept: application/vnd.github.v3+json' \
              -H 'Authorization: token ${{ github.token }}' \
              https://api.github.com/repos/${{ github.repository }}/releases/latest)
            
            # Check if request was successful
            if [[ \$? -ne 0 ]] || [[ -z \"\$LATEST_RELEASE\" ]]; then
              echo \"Error: Failed to fetch latest release\"
              exit 1
            fi
            
            # Extract and validate tag
            LATEST_TAG=\$(echo \"\$LATEST_RELEASE\" | jq -r '.tag_name')
            if [[ \"\$LATEST_TAG\" == \"\" ]] || [[ -z \"\$LATEST_TAG\" ]]; then
              echo \"Error: No valid tag found in latest release\"
              exit 1
            fi
            
            echo \"Latest tag: \$LATEST_TAG\"
            
            # More robust version increment using semver logic
            # Handle both \"v1.2.3\" and \"1.2.3\" formats
            CLEAN_TAG=\${LATEST_TAG#v}  # Remove 'v' prefix if present
            
            # Split version and increment patch
            IFS='.' read -ra VERSION_PARTS <<< \"\$CLEAN_TAG\"
            if [[ \${#VERSION_PARTS[@]} -ne 3 ]]; then
              echo \"Error: Tag format should be x.y.z (got \$LATEST_TAG)\"
              exit 1
            fi
            
            MAJOR=\${VERSION_PARTS[0]}
            MINOR=\${VERSION_PARTS[1]}
            PATCH=\${VERSION_PARTS[2]}
            
            # Validate numeric parts
            if ! [[ \"\$MAJOR\" =~ ^[0-9]+$ ]] || ! [[ \"\$MINOR\" =~ ^[0-9]+$ ]] || ! [[ \"\$PATCH\" =~ ^[0-9]+$ ]]; then
              echo \"Error: Version parts must be numeric (got \$LATEST_TAG)\"
              exit 1
            fi
            
            # Increment patch version
            NEW_PATCH=\$((PATCH + 1))
            NEW_TAG=\"\${LATEST_TAG/v/}\"  # Keep original format (with or without 'v')
            NEW_TAG=\"\${NEW_TAG/\$PATCH/\$NEW_PATCH}\"
            
            echo \"New tag: \$NEW_TAG\"
            
            # Check if tag already exists
            if git ls-remote --tags origin \"refs/tags/\$NEW_TAG\" | grep -q \"refs/tags/\$NEW_TAG\"; then
              echo \"Error: Tag \$NEW_TAG already exists\"
              exit 1
            fi
            
            # Create release with proper error handling
            RELEASE_BODY=\"Release \$NEW_TAG

            ## Changes
            - Automated release from workflow
            - Built with GitHub Actions
            - Enhanced logging and security
            
            ## Downloads
            - koishi-android-\$NEW_TAG.apk (basic version)
            - koishi-android-with-chromium-\$NEW_TAG.apk (full version)
            
            ## Build Information
            - Build logs with filtered sensitive data are available as artifacts
            - All security measures applied for log protection
            \"
            
            CREATE_RESPONSE=\$(curl \
              -sS \
              -X POST \
              -H 'Accept: application/vnd.github.v3+json' \
              -H 'Authorization: token ${{ github.token }}' \
              https://api.github.com/repos/${{ github.repository }}/releases \
              -d \"{\\\"tag_name\\\":\\\"\$NEW_TAG\\\",\\\"name\\\":\\\"Release \$NEW_TAG\\\",\\\"body\\\":\$(echo \"\$RELEASE_BODY\" | jq -Rs .)}\")
            
            # Check if release creation was successful
            RELEASE_URL=\$(echo \"\$CREATE_RESPONSE\" | jq -r '.html_url')
            if [[ \"\$RELEASE_URL\" == \"\" ]] || [[ -z \"\$RELEASE_URL\" ]]; then
              echo \"Error: Failed to create release\"
              echo \"Response: \$CREATE_RESPONSE\"
              exit 1
            fi
            
            echo \"âœ… Release created successfully: \$RELEASE_URL\"
            echo \"release_url=\$RELEASE_URL\" >> \$GITHUB_OUTPUT
            echo \"new_tag=\$NEW_TAG\" >> \$GITHUB_OUTPUT
          ")
          
          EXIT_CODE=${RELEASE_RESULT%%:*}
          LOG_FILE=${RELEASE_RESULT##*:}
          
          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "âŒ Release creation failed (exit code: $EXIT_CODE)"
            echo "ðŸ“‹ Check log file: $LOG_FILE"
            exit 1
          fi
          
          echo "::endgroup::"

      - name: Prepare logs for upload
        if: always()
        run: |
          BUILD_STATUS="${{ job.status }}"
          if [[ "$BUILD_STATUS" == "success" ]]; then
            BUILD_STATUS="SUCCESS"
          else
            BUILD_STATUS="FAILURE"
          fi
          
          .github/scripts/log-collector.sh summary "$BUILD_STATUS"
          .github/scripts/log-collector.sh upload "release-logs-$(date +%Y%m%d_%H%M%S)"

      - name: Upload release logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.upload.outputs.artifact_name }}
          path: ${{ steps.upload.outputs.archive_path }}
          retention-days: 30
          if-no-files-found: warn

      - name: Release Summary
        run: |
          echo "## ðŸ·ï¸ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ What's Next:" >> $GITHUB_STEP_SUMMARY
          echo "1. The `upload.yml` workflow will be automatically triggered" >> $GITHUB_STEP_SUMMARY
          echo "2. APKs will be built and uploaded to this release" >> $GITHUB_STEP_SUMMARY
          echo "3. Complete build logs are available as artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Logs and Debugging:" >> $GITHUB_STEP_SUMMARY
          echo "- Release creation logs are available as artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- All sensitive information has been filtered from logs" >> $GITHUB_STEP_SUMMARY
          echo "- Check the Actions tab for detailed build information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Downloads:" >> $GITHUB_STEP_SUMMARY
          echo "APKs will appear here once the upload workflow completes:" >> $GITHUB_STEP_SUMMARY
          echo "- koishi-android-*.apk (basic version)" >> $GITHUB_STEP_SUMMARY
          echo "- koishi-android-with-chromium-*.apk (full version)" >> $GITHUB_STEP_SUMMARY